<html>
  <head>
    <title>Notes</title>
    <style type="text/css">
      #note {
        font-family: Arial;
        font-size: 1.5rem;
        line-height: 1.4;
        margin: 0 auto;
        max-width: 60rem;
        outline: 0;
        padding: 4rem;
        white-space: pre-wrap;
      }
    </style>
  </head>

  <body>
    <div id="note" contenteditable />
  </body>

  <script type="text/javascript">
    // polyfills
    if (!Date.now) {
      Date.now = function now() {
        return new Date().getTime();
      };
    }
  
    // the code
    function note() {
      return document.getElementById("note");
    };

    function time() {
      window.sessionStorage.time = Date.now();
    };

    function save() {
      if (window.sessionStorage.time > window.localStorage.time) {
        window.localStorage.time = window.sessionStorage.time;
        window.localStorage.note = note().innerHTML;
      }
    };
    
    function insert(text) {
      if (window.getSelection) {
        var sel = window.getSelection();
        
        var range = sel.getRangeAt(0).cloneRange();
        range.deleteContents();
        
        var node = document.createTextNode(text);
        range.insertNode(node);
        
        // Move cursor to the end of the new node
        range.setStart(node, node.length);
        range.setEnd(node, node.length);
        sel.removeAllRanges();
        sel.addRange(range);
      } else if (document.selection && document.selection.createRange) {
        var range = document.selection.createRange();
        range.pasteHTML(text);
      }
    };
    
    function keydown(e) {
      if (document.activeElement && document.activeElement.id === 'note') {
        time();
      }
      
      if (e.keyCode === 9) {
        e.preventDefault();
        insert('	');
      }
    };

    window.onload = function() {
      // initialize time
      window.localStorage.time = window.localStorage.time || 0;
      
      // load previous stat and setup handlers
      note().innerHTML = window.localStorage.note || '';
      note().onblur = save;
      note().onkeydown = keydown;
      
      // focus the note
      note().focus();
    };

    window.onbeforeunload = save;
  </script>
</html>
